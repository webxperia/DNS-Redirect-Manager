#!/bin/sh

# Î§ÏÏÎ¼Î±Ï„Î± Î³Î¹Î± Ï„Î¿ Ï„ÎµÏÎ¼Î±Ï„Î¹ÎºÏŒ
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

show_menu() {
    clear
    echo "=================================================="
    echo "      DNS Redirect Manager - Setup Wizard"
    echo "=================================================="
    echo "1) Install / Update DNS Redirect Manager"
    echo "2) Uninstall DNS Redirect Manager"
    echo "3) Restart Services & Clear LuCI Cache"
    echo "4) Exit to Terminal"
    echo "=================================================="
    printf "Please choose an option [1-4]: "
}

do_install() {
    echo "ğŸ“ Creating directory structure..."
    mkdir -p /usr/lib/lua/luci/controller/admin
    mkdir -p /usr/lib/lua/luci/view/admin_dnsredirect
    mkdir -p /usr/share/dns-redirect
    mkdir -p /www/luci-static/dnsredirect
    chmod -R 755 /usr/lib/lua/luci/view/admin_dnsredirect
    
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘   DNS Redirect Manager - Dark Mode Default   â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    
    # 1. Create directories
    echo "ğŸ“ 1. Creating directory structure..."
    mkdir -p /usr/lib/lua/luci/controller/admin
    mkdir -p /usr/lib/lua/luci/view/admin_dnsredirect
    mkdir -p /usr/share/dns-redirect
    mkdir -p /www/luci-static/dnsredirect
    echo "   âœ… Directories created"
    
    # 2. Install required packages
    echo "ğŸ“¦ 2. Installing required packages..."
    opkg update >/dev/null 2>&1
    echo "   âœ… Packages checked"
    
    # 3. Create Controller (with theme support)
    echo "ğŸ® 3. Creating controller..."
    cat > /usr/lib/lua/luci/controller/admin/dnsredirect.lua << 'EOF'
module("luci.controller.admin.dnsredirect", package.seeall)

function index()
    entry({"admin", "services", "dnsredirect"}, template("admin_dnsredirect/dashboard"), _("DNS Redirect"), 60)
    entry({"admin", "services", "dnsredirect", "status"}, call("action_status"))
    entry({"admin", "services", "dnsredirect", "apply"}, call("action_apply"))
    entry({"admin", "services", "dnsredirect", "save"}, call("action_save"))
    entry({"admin", "services", "dnsredirect", "settheme"}, call("action_settheme"))
end

function action_status()
    local http = require("luci.http")
    local uci = require("luci.model.uci").cursor()
    
    local result = {
        success = true,
        rules = {},
        global = {enabled = false, dns = "1.1.1.1", theme = "dark"},
        counts = {total = 0, enabled = 0}
    }
    
    uci:foreach("dnsredirect", "rule",
        function(section)
            local rule = {
                id = section[".name"] or "",
                name = section.name or "Unnamed",
                ip = section.ip or "",
                dns = section.dns or "1.1.1.1",
                enabled = section.enabled or "0"
            }
            
            if rule.enabled == "1" then
                result.counts.enabled = result.counts.enabled + 1
            end
            
            table.insert(result.rules, rule)
            result.counts.total = result.counts.total + 1
        end)
    
    local global = uci:get_all("dnsredirect", "settings")
    if global then
        result.global.enabled = (global.enabled == "1")
        result.global.dns = global.dns_server or "1.1.1.1"
        result.global.theme = global.theme or "dark"
    end
    
    http.prepare_content("application/json")
    http.write_json(result)
end

function action_apply()
    local http = require("luci.http")
    local util = require("luci.util")
    
    http.prepare_content("application/json")
    
    local output = util.exec("/usr/share/dns-redirect/apply-rules.sh 2>&1")
    local success = output:find("successfully") or output:find("ACTIVE")
    
    http.write_json({
        success = success ~= nil,
        message = success and "Rules applied!" or "Application done",
        output = output
    })
end

function action_save()
    local http = require("luci.http")
    local uci = require("luci.model.uci").cursor()
    
    http.prepare_content("application/json")
    
    local name = http.formvalue("name")
    local ip = http.formvalue("ip")
    local dns = http.formvalue("dns")
    local enabled = http.formvalue("enabled") or "0"
    local action = http.formvalue("action")
    local rule_id = http.formvalue("id")
    
    if action == "delete" and rule_id then
        uci:delete("dnsredirect", rule_id)
    elseif name and ip and dns then
        if not rule_id then
            rule_id = "rule_" .. os.time()
        end
        
        uci:set("dnsredirect", rule_id, "rule")
        uci:set("dnsredirect", rule_id, "name", name)
        uci:set("dnsredirect", rule_id, "ip", ip)
        uci:set("dnsredirect", rule_id, "dns", dns)
        uci:set("dnsredirect", rule_id, "enabled", enabled)
    end
    
    -- Save global settings (including theme!)
    local global_enabled = http.formvalue("global_enabled")
    local global_dns = http.formvalue("global_dns")
    local global_theme = http.formvalue("global_theme")
    
    if global_dns or global_theme or global_enabled then
        uci:set("dnsredirect", "settings", "global")
        uci:set("dnsredirect", "settings", "enabled", global_enabled or "0")
        uci:set("dnsredirect", "settings", "dns_server", global_dns or "1.1.1.1")
        uci:set("dnsredirect", "settings", "theme", global_theme or "dark")
    end
    
    uci:commit("dnsredirect")
    
    http.write_json({
        success = true,
        message = "Saved!"
    })
end

function action_settheme()
    local http = require("luci.http")
    local uci = require("luci.model.uci").cursor()
    local theme = http.formvalue("theme")
    
    if theme and (theme == "light" or theme == "dark") then
        uci:set("dnsredirect", "settings", "global")
        uci:set("dnsredirect", "settings", "theme", theme)
        uci:commit("dnsredirect")
    end
    
    http.prepare_content("application/json")
    http.write_json({success = true, theme = theme})
end
EOF
    echo "   âœ… Controller created"
    
    # 4. Create Dashboard with Enhanced Dark Mode
    echo "ğŸ“Š 4. Creating dashboard with enhanced dark mode..."
    cat > /usr/lib/lua/luci/view/admin_dnsredirect/dashboard.htm << 'EOF'
<%+header%>
<style>
/* === LIGHT THEME === */
body[data-theme="light"] {
    --bg-primary: #ffffff;
    --bg-secondary: #f8f9fa;
    --bg-tertiary: #ffffff;
    --text-primary: #2c3e50;
    --text-secondary: #7f8c8d;
    --accent: #3498db;
    --accent-light: #5dade2;
    --success: #27ae60;
    --success-light: #2ecc71;
    --danger: #e74c3c;
    --danger-light: #ec7063;
    --warning: #f39c12;
    --warning-light: #f4d03f;
    --border: #dfe6e9;
    --border-light: #e8f4fc;
    --shadow: rgba(0,0,0,0.08);
    --card-shadow: 0 4px 6px rgba(0,0,0,0.04), 0 1px 3px rgba(0,0,0,0.08);
    --input-bg: #ffffff;
    --table-header: #f1f8ff;
}

/* === DARK THEME (Enhanced) === */
body[data-theme="dark"] {
    --bg-primary: #0d1117;
    --bg-secondary: #161b22;
    --bg-tertiary: #21262d;
    --text-primary: #f0f6fc;
    --text-secondary: #8b949e;
    --accent: #58a6ff;
    --accent-light: #79c0ff;
    --success: #238636;
    --success-light: #2ea043;
    --danger: #da3633;
    --danger-light: #f85149;
    --warning: #d29922;
    --warning-light: #e3b341;
    --border: #30363d;
    --border-light: #3c444d;
    --shadow: rgba(0,0,0,0.35);
    --card-shadow: 0 8px 24px rgba(0,0,0,0.25), 0 4px 12px rgba(0,0,0,0.15);
    --input-bg: #0d1117;
    --table-header: #1a2129;
}

/* Theme Toggle Switch INSIDE CARD */
.theme-toggle-container {
    position: absolute;
    top: 20px;
    right: 20px;
    z-index: 10;
}

.theme-toggle {
    width: 56px;
    height: 28px;
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
    border-radius: 28px;
    position: relative;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 2px solid var(--accent);
    overflow: hidden;
    box-shadow: var(--card-shadow);
}

.theme-toggle:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 8px 16px var(--shadow);
}

.theme-toggle:active {
    transform: translateY(0) scale(0.98);
}

.theme-toggle-icons {
    display: flex;
    justify-content: space-between;
    width: 100%;
    align-items: center;
    position: relative;
    z-index: 2;
    padding: 0 6px;
    height: 100%;
}

.sun-icon, .moon-icon {
    font-size: 14px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
    filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
}

body[data-theme="light"] .sun-icon {
    color: #ff9f1c;
    filter: drop-shadow(0 0 6px rgba(255, 159, 28, 0.8));
}

body[data-theme="dark"] .sun-icon {
    color: #8b949e;
    opacity: 0.6;
}

body[data-theme="light"] .moon-icon {
    color: #8b949e;
    opacity: 0.6;
}

body[data-theme="dark"] .moon-icon {
    color: #f0f6fc;
    filter: drop-shadow(0 0 6px rgba(240, 246, 252, 0.4));
}

.toggle-slider-round {
    position: absolute;
    height: 22px;
    width: 22px;
    left: 3px;
    bottom: 3px;
    background: white;
    transition: .3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    border-radius: 50%;
    z-index: 1;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

body[data-theme="dark"] .toggle-slider-round {
    transform: translateX(28px);
    background: linear-gradient(135deg, #f0f6fc 0%, #c9d1d9 100%);
}

/* Theme badge */
.theme-badge {
    display: inline-block;
    margin-left: 10px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
    color: white;
    vertical-align: middle;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Main header with theme toggle */
.main-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    position: relative;
}

.main-header h2 {
    margin: 0 !important;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* Shared styles */
body {
    background-color: var(--bg-primary) !important;
    color: var(--text-primary) !important;
    transition: background-color 0.3s ease, color 0.3s ease;
}

.cbi-map {
    background: transparent !important;
    padding: 0 !important;
}

.card {
    background: var(--bg-secondary);
    border-radius: 16px;
    padding: 28px;
    margin-bottom: 28px;
    box-shadow: var(--card-shadow);
    border: 1px solid var(--border);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    backdrop-filter: blur(10px);
}

.card:hover {
    box-shadow: 0 12px 28px var(--shadow);
    transform: translateY(-2px);
    border-color: var(--accent);
}

.card-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--border);
}

h2, h3 {
    color: var(--accent) !important;
    margin-top: 0;
    margin-bottom: 5px;
    font-weight: 700 !important;
}

h2 {
    font-size: 28px !important;
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

h3 {
    font-size: 20px !important;
}

p {
    color: var(--text-secondary);
    line-height: 1.6;
}

.subtitle {
    font-size: 14px;
    color: var(--text-secondary);
    margin-top: 5px;
    opacity: 0.9;
}

/* Toggle switches */
.toggle {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 32px;
}
.toggle input {
    opacity: 0;
    width: 0;
    height: 0;
}
.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, var(--border) 0%, var(--border-light) 100%);
    transition: .4s;
    border-radius: 32px;
}
.toggle-slider:before {
    position: absolute;
    content: "";
    height: 24px;
    width: 24px;
    left: 4px;
    bottom: 4px;
    background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
    transition: .4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
input:checked + .toggle-slider {
    background: linear-gradient(135deg, var(--success) 0%, var(--success-light) 100%);
}
input:checked + .toggle-slider:before {
    transform: translateX(28px);
}

/* Buttons */
.btn {
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    font-size: 14px;
    letter-spacing: 0.3px;
}

.btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
    filter: brightness(1.1);
}

.btn:active {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
}

.btn-danger {
    background: linear-gradient(135deg, var(--danger) 0%, var(--danger-light) 100%);
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
}

.btn-success {
    background: linear-gradient(135deg, var(--success) 0%, var(--success-light) 100%);
    box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
}

.btn-warning {
    background: linear-gradient(135deg, var(--warning) 0%, var(--warning-light) 100%);
    color: #1a1d29;
    box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
}

.btn-sm {
    padding: 8px 16px;
    font-size: 13px;
    border-radius: 10px;
}

.btn-icon {
    font-size: 16px;
    filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
}

/* Form elements */
input[type="text"] {
    background: var(--input-bg);
    border: 2px solid var(--border);
    color: var(--text-primary);
    padding: 12px 16px;
    border-radius: 10px;
    width: 100%;
    margin-top: 8px;
    transition: all 0.3s;
    font-size: 14px;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

input[type="text"]:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.15), inset 0 2px 4px rgba(0,0,0,0.1);
}

select {
    background: var(--input-bg);
    color: var(--text-primary);
    border: 2px solid var(--border);
    padding: 12px 16px;
    border-radius: 10px;
    margin-top: 8px;
    font-size: 14px;
    width: 100%;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

/* Tables */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 16px;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--border);
    box-shadow: 0 4px 12px var(--shadow);
}
th {
    background: var(--table-header);
    padding: 18px 16px;
    text-align: left;
    color: var(--accent);
    border-bottom: 2px solid var(--border);
    font-weight: 700;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
td {
    padding: 20px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 14px;
    transition: background 0.2s;
}
tr:last-child td {
    border-bottom: none;
}
tr:hover td {
    background: rgba(var(--accent-rgb), 0.08);
}

/* Code blocks */
code {
    background: var(--bg-tertiary);
    padding: 4px 8px;
    border-radius: 6px;
    font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
    font-size: 13px;
    border: 1px solid var(--border);
    color: var(--accent);
}

/* Modal */
#rule-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(8px);
}
#rule-modal > div {
    background: var(--bg-secondary);
    padding: 32px;
    border-radius: 20px;
    min-width: 450px;
    border: 1px solid var(--border);
    box-shadow: 0 24px 48px rgba(0,0,0,0.4);
    max-width: 90%;
    max-height: 90%;
    overflow-y: auto;
    animation: modalSlide 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes modalSlide {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Status badges */
.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.enabled-badge {
    background: rgba(39, 174, 96, 0.15);
    color: var(--success);
    border: 2px solid rgba(39, 174, 96, 0.3);
}
.disabled-badge {
    background: rgba(231, 76, 60, 0.15);
    color: var(--danger);
    border: 2px solid rgba(231, 76, 60, 0.3);
}

/* Rules stats */
.rules-stats {
    display: flex;
    gap: 16px;
    margin-top: 16px;
    flex-wrap: wrap;
}
.stat-item {
    display: flex;
    flex-direction: column;
    padding: 16px 20px;
    background: var(--bg-tertiary);
    border-radius: 12px;
    border: 1px solid var(--border);
    min-width: 140px;
    transition: all 0.3s;
    flex: 1;
}
.stat-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px var(--shadow);
    border-color: var(--accent);
}
.stat-value {
    font-size: 32px;
    font-weight: 800;
    color: var(--accent);
    line-height: 1;
    margin-bottom: 4px;
}
.stat-label {
    font-size: 13px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
}

/* Form groups */
.form-group {
    margin-bottom: 24px;
}
.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 14px;
}

/* Action buttons container */
.action-buttons {
    display: flex;
    gap: 16px;
    margin-top: 24px;
    flex-wrap: wrap;
}

/* Responsive */
@media (max-width: 768px) {
    .card {
        padding: 20px;
    }
    
    .theme-toggle {
        width: 52px;
        height: 26px;
    }
    
    .toggle-slider-round {
        height: 20px;
        width: 20px;
    }
    
    body[data-theme="dark"] .toggle-slider-round {
        transform: translateX(26px);
    }
    
    .rules-stats {
        flex-direction: column;
    }
    
    .stat-item {
        min-width: auto;
    }
}

/* Glow effect for dark mode */
body[data-theme="dark"] .btn {
    box-shadow: 0 4px 20px rgba(88, 166, 255, 0.25);
}

body[data-theme="dark"] .btn:hover {
    box-shadow: 0 8px 30px rgba(88, 166, 255, 0.4);
}

body[data-theme="dark"] .stat-item {
    background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(33, 38, 45, 0.8) 100%);
}

body[data-theme="dark"] input[type="text"]:focus {
    box-shadow: 0 0 0 4px rgba(88, 166, 255, 0.2), inset 0 2px 4px rgba(0,0,0,0.3);
}

/* Loading animation */
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.loading {
    animation: pulse 1.5s infinite;
}
</style>

<div class="cbi-map">
    <!-- Main Card with Theme Toggle INSIDE -->
    <div class="card">
        <div class="main-header">
            <div>
                <h2>ğŸŒ DNS Redirect Manager</h2>
                <p class="subtitle">Manage DNS redirection for specific devices. Current theme: <span id="current-theme-badge" class="theme-badge">Dark</span></p>
            </div>
            <div class="theme-toggle-container">
                <div class="theme-toggle" onclick="toggleTheme()" title="Click to toggle theme (Ctrl+T)">
                    <div class="theme-toggle-icons">
                        <span class="sun-icon">â˜€ï¸</span>
                        <span class="moon-icon">ğŸŒ™</span>
                    </div>
                    <div class="toggle-slider-round"></div>
                </div>
            </div>
        </div>
        
        <div class="rules-stats">
            <div class="stat-item">
                <span class="stat-value" id="total-rules">0</span>
                <span class="stat-label">Total Rules</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="active-rules">0</span>
                <span class="stat-label">Active Rules</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="theme-indicator">ğŸŒ™</span>
                <span class="stat-label">Theme</span>
            </div>
        </div>
    </div>

    <!-- Global Settings Card -->
    <div class="card">
        <div class="card-title">
            <h3>âš™ï¸ Global Settings</h3>
        </div>
        
        <div class="form-group">
            <label>Enable Global DNS Redirect:</label>
            <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                <label class="toggle">
                    <input type="checkbox" id="global-enabled">
                    <span class="toggle-slider"></span>
                </label>
                <span id="global-status-text" style="color: var(--text-secondary); font-size: 14px;">Disabled</span>
            </div>
        </div>
        
        <div id="global-dns-section" style="margin-top: 20px; display: none;">
            <div class="form-group">
                <label for="global-dns">DNS Server:</label>
                <input type="text" id="global-dns" placeholder="e.g., 1.1.1.1, 8.8.8.8">
                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                    Popular DNS: 1.1.1.1 (Cloudflare), 8.8.8.8 (Google), 9.9.9.9 (Quad9)
                </div>
            </div>
        </div>
        
        <div class="action-buttons">
            <button onclick="saveGlobalSettings()" class="btn">
                <span class="btn-icon">ğŸ’¾</span> Save Global Settings
            </button>
        </div>
    </div>

    <!-- Rules Card -->
    <div class="card">
        <div class="card-title">
            <h3>ğŸ“‹ Rules Management</h3>
            <button onclick="showAddRule()" class="btn">
                <span class="btn-icon">â•</span> Add Rule
            </button>
        </div>
        
        <div id="rules-list">
            <p style="text-align: center; padding: 40px 0; color: var(--text-secondary);">
                Loading rules...
            </p>
        </div>
    </div>

    <!-- Actions Card -->
    <div class="card">
        <div class="card-title">
            <h3>ğŸš€ Actions</h3>
        </div>
        
        <div class="action-buttons">
            <button onclick="applyRules()" class="btn btn-success">
                <span class="btn-icon">âš¡</span> Apply Rules to Firewall
            </button>
            <button onclick="refresh()" class="btn">
                <span class="btn-icon">ğŸ”„</span> Refresh
            </button>
            <button onclick="exportRules()" class="btn">
                <span class="btn-icon">ğŸ“¤</span> Export
            </button>
            <button onclick="importRules()" class="btn btn-warning">
                <span class="btn-icon">ğŸ“¥</span> Import
            </button>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border);">
            <div style="font-size: 13px; color: var(--text-secondary);">
                <strong>ğŸ’¡ Tip:</strong> Press <code>Ctrl+T</code> to toggle theme quickly.
            </div>
        </div>
    </div>
</div>

<script>
let rules = [];
let currentTheme = 'dark';

// Theme toggle function
function toggleTheme() {
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    switchTheme(newTheme);
}

function switchTheme(theme) {
    currentTheme = theme;
    document.body.setAttribute('data-theme', theme);
    
    // Update theme badge
    const badge = document.getElementById('current-theme-badge');
    badge.textContent = theme.charAt(0).toUpperCase() + theme.slice(1);
    
    // Update theme indicator
    const indicator = document.getElementById('theme-indicator');
    indicator.textContent = theme === 'light' ? 'â˜€ï¸' : 'ğŸŒ™';
    
    // Save theme preference immediately
    const form = new FormData();
    form.append('theme', theme);
    
    fetch('<%=url("admin/services/dnsredirect/settheme")%>', {
        method: 'POST',
        body: form
    })
    .then(r => r.json())
    .then(data => {
        console.log('Theme saved:', data.theme);
    });
}

function refresh() {
    fetch('<%=url("admin/services/dnsredirect/status")%>')
        .then(r => r.json())
        .then(data => {
            const theme = data.global.theme || 'dark';
            if (theme !== currentTheme) {
                switchTheme(theme);
            }
            updateStats(data);
            updateRules(data.rules);
            updateGlobal(data.global);
        })
        .catch(error => {
            console.error('Error refreshing:', error);
            alert('Error refreshing data. Please check console.');
        });
}

function updateStats(data) {
    document.getElementById('total-rules').textContent = data.counts.total;
    document.getElementById('active-rules').textContent = data.counts.enabled;
}

function updateRules(rulesList) {
    rules = rulesList;
    const container = document.getElementById('rules-list');
    
    if (!rulesList.length) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px 0;">
                <div style="font-size: 48px; color: var(--text-secondary); margin-bottom: 15px;">ğŸ“‹</div>
                <h3 style="color: var(--text-secondary);">No Rules Configured</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Create your first DNS redirect rule</p>
                <button onclick="showAddRule()" class="btn">â• Create First Rule</button>
            </div>
        `;
        return;
    }
    
    let html = '<table>';
    html += `
        <thead>
            <tr>
                <th>Name</th>
                <th>Device IP</th>
                <th>DNS Server</th>
                <th>Status</th>
                <th style="width: 150px;">Actions</th>
            </tr>
        </thead>
        <tbody>
    `;
    
    rulesList.forEach(rule => {
        const isEnabled = rule.enabled === '1';
        const statusBadge = isEnabled 
            ? '<span class="status-badge enabled-badge">âœ… Active</span>' 
            : '<span class="status-badge disabled-badge">â›” Inactive</span>';
            
        html += `
            <tr>
                <td><strong>${rule.name}</strong></td>
                <td><code>${rule.ip}</code></td>
                <td><code>${rule.dns}</code></td>
                <td>${statusBadge}</td>
                <td>
                    <div style="display: flex; gap: 6px;">
                        <button onclick="editRule('${rule.id}')" class="btn btn-sm" title="Edit">
                            âœï¸ Edit
                        </button>
                        <button onclick="toggleRuleStatus('${rule.id}', ${!isEnabled})" class="btn btn-sm ${isEnabled ? 'btn-danger' : 'btn-success'}" title="${isEnabled ? 'Disable' : 'Enable'}">
                            ${isEnabled ? 'â›”' : 'âœ…'} ${isEnabled ? 'Disable' : 'Enable'}
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

function toggleRuleStatus(ruleId, enable) {
    const rule = rules.find(r => r.id === ruleId);
    if (!rule) return;
    
    const form = new FormData();
    form.append('name', rule.name);
    form.append('ip', rule.ip);
    form.append('dns', rule.dns);
    form.append('enabled', enable ? '1' : '0');
    form.append('id', ruleId);
    
    fetch('<%=url("admin/services/dnsredirect/save")%>', {
        method: 'POST',
        body: form
    })
    .then(r => r.json())
    .then(data => {
        console.log('Rule toggled:', data.message);
        refresh();
    });
}

function updateGlobal(global) {
    const isEnabled = global.enabled;
    document.getElementById('global-enabled').checked = isEnabled;
    document.getElementById('global-status-text').textContent = isEnabled ? 'Enabled' : 'Disabled';
    document.getElementById('global-status-text').style.color = isEnabled ? 'var(--success)' : 'var(--danger)';
    
    document.getElementById('global-dns').value = global.dns || '1.1.1.1';
    document.getElementById('global-dns-section').style.display = isEnabled ? 'block' : 'none';
}

document.getElementById('global-enabled').addEventListener('change', function() {
    const isEnabled = this.checked;
    document.getElementById('global-status-text').textContent = isEnabled ? 'Enabled' : 'Disabled';
    document.getElementById('global-status-text').style.color = isEnabled ? 'var(--success)' : 'var(--danger)';
    document.getElementById('global-dns-section').style.display = isEnabled ? 'block' : 'none';
});

function saveGlobalSettings() {
    const enabled = document.getElementById('global-enabled').checked ? '1' : '0';
    const dns = document.getElementById('global-dns').value;
    
    // Validate DNS
    const dnsPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
    if (enabled === '1' && !dnsPattern.test(dns)) {
        alert('âš ï¸ Please enter a valid DNS server IP address!');
        return;
    }
    
    const form = new FormData();
    form.append('global_enabled', enabled);
    form.append('global_dns', dns);
    form.append('global_theme', currentTheme);
    
    fetch('<%=url("admin/services/dnsredirect/save")%>', {
        method: 'POST',
        body: form
    })
    .then(r => r.json())
    .then(data => {
        showNotification('âœ… ' + data.message, 'success');
        refresh();
    });
}

// --- Rule Management ---
function showAddRule(ruleId) {
    let title = 'â• Add New Rule';
    let rule = {name: '', ip: '', dns: '1.1.1.1', enabled: '1'};
    let isEdit = false;
    
    if (ruleId) {
        title = 'âœï¸ Edit Rule';
        rule = rules.find(r => r.id === ruleId) || rule;
        isEdit = true;
    }
    
    const html = `
        <div id="rule-modal">
            <div>
                <h3 style="margin-top:0;color:var(--accent);">${title}</h3>
                <p style="color:var(--text-secondary);margin-top:0;margin-bottom:20px;">
                    ${isEdit ? 'Modify an existing DNS redirect rule' : 'Create a new DNS redirect rule for a specific device'}
                </p>
                
                <div class="form-group">
                    <label for="rule-name">Rule Name:</label>
                    <input type="text" id="rule-name" value="${rule.name}" placeholder="e.g., My Computer, Kid's Phone">
                    <div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">Descriptive name for this rule</div>
                </div>
                
                <div class="form-group">
                    <label for="rule-ip">Device IP Address:</label>
                    <input type="text" id="rule-ip" value="${rule.ip}" placeholder="e.g., 192.168.1.100">
                    <div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">The IP address of the device to redirect</div>
                </div>
                
                <div class="form-group">
                    <label for="rule-dns">DNS Server:</label>
                    <input type="text" id="rule-dns" value="${rule.dns}" placeholder="e.g., 1.1.1.1">
                    <div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">DNS server to redirect to (e.g., 1.1.1.1 for Cloudflare)</div>
                </div>
                
                <div class="form-group">
                    <label>Rule Status:</label>
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                        <label class="toggle">
                            <input type="checkbox" id="rule-enabled" ${rule.enabled === '1' ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                        <span id="rule-status-text" style="color: var(--text-secondary); font-size: 14px;">
                            ${rule.enabled === '1' ? 'Enabled' : 'Disabled'}
                        </span>
                    </div>
                </div>
                
                <div style="display:flex;gap:12px;margin-top:30px;">
                    <button onclick="saveRule('${ruleId || ''}')" class="btn" style="flex:1;">
                        <span class="btn-icon">ğŸ’¾</span> ${isEdit ? 'Update Rule' : 'Create Rule'}
                    </button>
                    <button onclick="closeModal()" class="btn btn-danger" style="flex:1;">
                        <span class="btn-icon">âœ–ï¸</span> Cancel
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', html);
    
    // Update status text when toggle changes
    document.getElementById('rule-enabled')?.addEventListener('change', function() {
        document.getElementById('rule-status-text').textContent = this.checked ? 'Enabled' : 'Disabled';
        document.getElementById('rule-status-text').style.color = this.checked ? 'var(--success)' : 'var(--danger)';
    });
}

function closeModal() {
    const modal = document.getElementById('rule-modal');
    if (modal) modal.remove();
}

function saveRule(ruleId) {
    const name = document.getElementById('rule-name').value;
    const ip = document.getElementById('rule-ip').value;
    const dns = document.getElementById('rule-dns').value;
    const enabled = document.getElementById('rule-enabled').checked ? '1' : '0';
    
    if (!name || !ip || !dns) {
        showNotification('âš ï¸ Please fill all fields!', 'warning');
        return;
    }
    
    // Validate IP
    const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
    if (!ipPattern.test(ip)) {
        showNotification('âš ï¸ Please enter a valid IP address!', 'warning');
        return;
    }
    
    // Validate DNS
    const dnsPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
    if (!dnsPattern.test(dns)) {
        showNotification('âš ï¸ Please enter a valid DNS server IP address!', 'warning');
        return;
    }
    
    const form = new FormData();
    form.append('name', name);
    form.append('ip', ip);
    form.append('dns', dns);
    form.append('enabled', enabled);
    if (ruleId) form.append('id', ruleId);
    
    fetch('<%=url("admin/services/dnsredirect/save")%>', {
        method: 'POST',
        body: form
    })
    .then(r => r.json())
    .then(data => {
        showNotification('âœ… ' + data.message, 'success');
        closeModal();
        refresh();
    });
}

function editRule(ruleId) {
    showAddRule(ruleId);
}

function deleteRule(ruleId) {
    const rule = rules.find(r => r.id === ruleId);
    if (!rule) return;
    
    if (!confirm(`ğŸ—‘ï¸ Delete rule "${rule.name}" (${rule.ip}) permanently?`)) return;
    
    const form = new FormData();
    form.append('action', 'delete');
    form.append('id', ruleId);
    
    fetch('<%=url("admin/services/dnsredirect/save")%>', {
        method: 'POST',
        body: form
    })
    .then(r => r.json())
    .then(data => {
        showNotification('âœ… ' + data.message, 'success');
        refresh();
    });
}

function applyRules() {
    if (!confirm('âš¡ Apply all active rules to firewall?\n\nThis will:\nâ€¢ Update firewall configuration\nâ€¢ Restart firewall service\nâ€¢ Apply DNS redirects immediately')) return;
    
    showNotification('âš¡ Applying rules to firewall...', 'info');
    
    fetch('<%=url("admin/services/dnsredirect/apply")%>')
        .then(r => r.json())
        .then(data => {
            const message = data.success ? 'âœ… Rules applied successfully!' : 'âš ï¸ Rules applied with warnings';
            alert(message + '\n\nğŸ“‹ Output:\n' + data.output);
            refresh();
        });
}

function showNotification(message, type = 'info') {
    // Simple alert for now - could be enhanced with a proper notification system
    console.log(`${type}: ${message}`);
}

function exportRules() {
    const exportData = {
        rules: rules,
        global: {
            enabled: document.getElementById('global-enabled').checked,
            dns: document.getElementById('global-dns').value,
            theme: currentTheme
        },
        exportedAt: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `dns-redirect-rules-${new Date().toISOString().slice(0,10)}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showNotification('âœ… Rules exported successfully!', 'success');
}

function importRules() {
    alert('ğŸ“¥ Import feature would be implemented here!\n\nThis would allow importing rules from a JSON file.');
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
    }
    if (e.key === 'F5') {
        e.preventDefault();
        refresh();
    }
    if ((e.ctrlKey || e.metaKey) && e.key === 't') {
        e.preventDefault();
        toggleTheme();
    }
    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        showAddRule();
    }
});

// Initial load - force dark theme on first load
window.addEventListener('DOMContentLoaded', function() {
    // Set dark theme as default
    document.body.setAttribute('data-theme', 'dark');
    currentTheme = 'dark';
    
    // Update UI elements
    const badge = document.getElementById('current-theme-badge');
    if (badge) badge.textContent = 'Dark';
    
    const indicator = document.getElementById('theme-indicator');
    if (indicator) indicator.textContent = 'ğŸŒ™';
    
    // Then refresh data
    setTimeout(refresh, 100);
});

// Add helpful console message
setTimeout(() => {
    console.log('ğŸ¨ DNS Redirect Manager loaded!');
    console.log('ğŸ¯ Dark mode is now default');
    console.log('ğŸ’¡ Keyboard shortcuts:');
    console.log('   â€¢ Ctrl+T: Toggle theme');
    console.log('   â€¢ Ctrl+N: New rule');
    console.log('   â€¢ F5: Refresh');
    console.log('   â€¢ Escape: Close modal');
}, 1000);
</script>
<%+footer%>
EOF
    echo "   âœ… Dashboard created with enhanced dark mode"
    
    # 5. Create Apply Script
    echo "âš¡ 5. Creating apply script..."
    cat > /usr/share/dns-redirect/apply-rules.sh << 'EOF'
#!/bin/sh
# DNS Redirect Apply Script

echo "Starting DNS redirect configuration..."

for section in $(uci show firewall 2>/dev/null | grep "=redirect" | cut -d. -f2 | cut -d= -f1); do
    if uci -q get firewall.$section.name 2>/dev/null | grep -q "^dns_redirect_\|^dns_global_redirect$"; then
        uci delete firewall.$section 2>/dev/null
    fi
done

uci -q show dnsredirect 2>/dev/null | grep "=rule" | cut -d. -f2 | cut -d= -f1 | while read rule; do
    enabled=$(uci -q get dnsredirect.$rule.enabled)
    ip=$(uci -q get dnsredirect.$rule.ip)
    dns=$(uci -q get dnsredirect.$rule.dns)
    
    if [ "$enabled" = "1" ] && [ -n "$ip" ] && [ -n "$dns" ]; then
        rule_id="dns_redirect_$(echo $ip | tr '.' '_')"
        
        uci set firewall.$rule_id=redirect
        uci set firewall.$rule_id.name="$rule_id"
        uci set firewall.$rule_id.src="lan"
        uci set firewall.$rule_id.src_ip="$ip"
        uci set firewall.$rule_id.src_dport="53"
        uci set firewall.$rule_id.proto="tcpudp"
        uci set firewall.$rule_id.dest_ip="$dns"
        uci set firewall.$rule_id.target="DNAT"
    fi
done

GLOBAL_ENABLED=$(uci -q get dnsredirect.settings.enabled)
GLOBAL_DNS=$(uci -q get dnsredirect.settings.dns_server)

if [ "$GLOBAL_ENABLED" = "1" ] && [ -n "$GLOBAL_DNS" ]; then
    uci set firewall.dns_global_redirect=redirect
    uci set firewall.dns_global_redirect.name="dns_global_redirect"
    uci set firewall.dns_global_redirect.src="lan"
    uci set firewall.dns_global_redirect.src_dport="53"
    uci set firewall.dns_global_redirect.proto="tcpudp"
    uci set firewall.dns_global_redirect.dest_ip="$GLOBAL_DNS"
    uci set firewall.dns_global_redirect.target="DNAT"
fi

uci commit firewall
/etc/init.d/firewall restart >/dev/null 2>&1

echo "DNS redirect rules applied successfully!"
EOF
    
    chmod +x /usr/share/dns-redirect/apply-rules.sh
    echo "   âœ… Apply script created"
    
    # 6. Create Configuration File (with dark mode as default)
    echo "âš™ï¸ 6. Creating configuration file..."
    cat > /etc/config/dnsredirect << 'EOF'
config global 'settings'
    option enabled '0'
    option dns_server '1.1.1.1'
    option theme 'dark'
EOF
    echo "   âœ… Configuration file created with dark mode as default"
    
    # 7. Create theme helper script with dark mode default
    echo "ğŸ¨ 7. Creating theme helper..."
    cat > /www/luci-static/dnsredirect/theme-switcher.js << 'EOF'
// DNS Redirect Theme Switcher - Dark Mode Default
(function() {
    'use strict';
    
    // Apply dark theme as default
    function applyDarkTheme() {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('dnsredirect-theme', 'dark');
        
        // Add smooth transitions
        const style = document.createElement('style');
        style.textContent = `
            body, .card, input, select, button, table, th, td {
                transition: background-color 0.3s ease, 
                           color 0.3s ease, 
                           border-color 0.3s ease,
                           box-shadow 0.3s ease !important;
            }
        `;
        document.head.appendChild(style);
    }
    
    // Apply theme on DOM ready
    document.addEventListener('DOMContentLoaded', function() {
        // Force dark theme first
        applyDarkTheme();
        
        // Then try to load saved theme (but dark is default)
        try {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/cgi-bin/luci/admin/services/dnsredirect/status', false);
            xhr.send();
            if (xhr.status === 200) {
                const data = JSON.parse(xhr.responseText);
                const savedTheme = data.global?.theme;
                if (savedTheme === 'light') {
                    document.documentElement.setAttribute('data-theme', 'light');
                    localStorage.setItem('dnsredirect-theme', 'light');
                }
            }
        } catch (e) {
            console.log('DNS Redirect: Could not load theme:', e);
            // Keep dark theme as default
        }
    });
    
    // Sync theme across tabs
    window.addEventListener('storage', function(e) {
        if (e.key === 'dnsredirect-theme') {
            document.documentElement.setAttribute('data-theme', e.newValue || 'dark');
        }
    });
})();
EOF
    echo "   âœ… Theme helper created with dark mode default"
    
    # 8. Restart Services
    echo "ğŸ”„ 8. Restarting services..."
    /etc/init.d/uhttpd restart >/dev/null 2>&1
    sleep 2
    
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          INSTALLATION COMPLETE! ğŸ‰         â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "âœ¨ Enhanced Dark Mode Features:"
    echo "   â€¢ ğŸŒ™ Dark mode as DEFAULT theme"
    echo "   â€¢ Enhanced dark colors (GitHub Dark theme inspired)"
    echo "   â€¢ Better gradients and shadows"
    echo "   â€¢ Smooth animations and transitions"
    echo "   â€¢ Glow effects for buttons in dark mode"
    echo "   â€¢ Enhanced form elements with better contrast"
    echo "   â€¢ Responsive design improvements"
    echo "   â€¢ Premium dark theme aesthetics"
    echo ""
    echo "ğŸ¯ Theme switcher is now inside the 'DNS Redirect Manager' card"
    echo "   at the top-right corner - Click to switch between dark/light!"
    echo ""
    echo "Access: LuCI â†’ Services â†’ DNS Redirect"
    echo ""
    echo "ğŸ“ Files installed:"
    echo "  â€¢ /usr/lib/lua/luci/controller/admin/dnsredirect.lua"
    echo "  â€¢ /usr/lib/lua/luci/view/admin_dnsredirect/dashboard.htm"
    echo "  â€¢ /usr/share/dns-redirect/apply-rules.sh"
    echo "  â€¢ /etc/config/dnsredirect (dark mode default)"
    echo "  â€¢ /www/luci-static/dnsredirect/theme-switcher.js"
    echo ""
    echo "ğŸ”„ Refresh LuCI page if menu doesn't appear immediately."
    
    do_restart
    echo -e "${GREEN}âœ… Installation Complete!${NC}"
    read -p "Press Enter to return to menu..." temp
}

do_uninstall() {
    echo -e "${RED}ğŸ—‘ï¸ Uninstalling...${NC}"
    rm -rf /usr/lib/lua/luci/view/admin_dnsredirect
    rm -f /usr/lib/lua/luci/controller/admin/dnsredirect.lua
    rm -rf /usr/share/dns-redirect
    rm -rf /www/luci-static/dnsredirect
    rm -f /etc/config/dnsredirect
    do_restart
    echo -e "${GREEN}âœ… Uninstalled successfully.${NC}"
    read -p "Press Enter to return to menu..." temp
}

do_restart() {
    echo -e "${YELLOW}ğŸ”„ Cleaning cache & restarting uhttpd...${NC}"
    rm -rf /tmp/luci-indexcache /tmp/luci-modulecache/
    /etc/init.d/uhttpd restart
}

# Main Loop
while true; do
    show_menu
    read choice
    case $choice in
        1) do_install ;;
        2) do_uninstall ;;
        3) do_restart; read -p "Done. Press Enter..." temp ;;
        4) exit 0 ;;
        *) echo "Invalid option"; sleep 1 ;;
    esac
done
